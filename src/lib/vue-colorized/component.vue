<!-- basically https://stackoverflow.com/q/9163283/3423324 as vue component -->
<template>
  <img :src="computedSrc" ref="img" />
</template>

<!--<body>
  <div class="foobar" v-colorized-bg="hue"></div>
  <div class="foobar" v-colorized-bg.full-scale="hue"></div>
</body>-->
<script>
import common from './common';

export default {
  name: 'vue-colorized',
  props: {
    hue: {
      default: null,
      type: Number,
      required: false,
    },
    saturation: {
      default: null,
      type: Number,
      required: false,
    },
    lightness: {
      default: null,
      type: Number,
      required: false,
    },
    src: {
      default: null,
      type: String,
    },
    /**
     * If set to true it will scale the `src` image to the current dimensions this contained `<img>`
     * element takes.
     * This might reduce processing power for smaller
     */
    preScale: {
      default: true,
      type: Boolean,
    },
  },
  data() {
    return {
      computedSrc: this.src,
    };
  },
  computed: {
    img() {
      return common.createImage(this.src, this.imageLoaded);
    },
  },
  watch: {
    src() { this.loadImage(); },
    hue() { this.applyImage(); },
    saturation() { this.applyImage(); },
    lightness() { this.applyImage(); },
    preScale() { this.applyImage(); },
  },
  methods: {
    loadImage() {
      // update src to force loading
      this.img.src = this.src;
      // check if already loaded
      if (this.img.complete) {
        // if already loaded, no onload event will be triggered.
        // we handle that case here, by calling the function directly.
        this.applyImage();
      }
    },
    imageLoaded(event) {
      this.applyImage(this.img);
    },
    applyImage() {
      const { width, height } = common.calculateScale(this.preScale, this.$refs.img, this.img);
      const computedSrc = common.calculateImage(this.img, width, height, this.hue, this.saturation, this.lightness);
      if (!computedSrc) {
        return; // we couldn't calculate anything, as the image was not yet loaded.
      }
      this.computedSrc = computedSrc;
    },
  },
  mounted() {
    if (this.src) {
      this.loadImage();
    }
  },
};
</script>

<style scoped></style>
